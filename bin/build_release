#!/usr/bin/env bash

set -eo pipefail

# Navigate to the bin directory (where this script lives) to ensure we can run this script
# from anywhere.
cd "$(dirname "$0")"

. ./build_utils

function main() {
    local REPO_ROOT
    local PROJECT_WD
    local VERSION
    local GO_VERSION
    local GORELEASER_IMAGE

    # Use a GoReleaser Docker image containing cross-compilation tools
    # This image is recommended by the official GoReleaser docs
    # https://goreleaser.com/cookbooks/cgo-and-crosscompiling/
    GORELEASER_IMAGE="goreleaser/goreleaser-cross:v1.19"

    REPO_ROOT="$(repo_root)"
    PROJECT_WD="github.cyberng.com/Conjur-Enterprise/conjur-cli-go"
    VERSION="$(project_semantic_version)"

    # Get the version of Go specified by the "go directive" in go.mod
    # Grep it to avoid Go binary dependency
    GO_VERSION="v$(grep "^\bgo\b" "${REPO_ROOT}/go.mod" | awk '{print $2}')"

    docker build -f "${REPO_ROOT}/Dockerfile.builder" -t conjur-cli-go-builder .

    # Compile FIPS binaries with RedHat UBI
    docker run --rm \
      --env VERSION="${VERSION}" \
      --volume "${REPO_ROOT}:/${PROJECT_WD}" \
      --workdir "/${PROJECT_WD}" \
      conjur-cli-go-builder

    # Compile binaries with Go Releaser
    echo "Docker image for release build: ${GORELEASER_IMAGE}"
    docker run --rm \
      --env VERSION="${VERSION}" \
      --env GO_VERSION="${GO_VERSION}" \
      --volume "${REPO_ROOT}:/${PROJECT_WD}" \
      --workdir "/${PROJECT_WD}" \
      "${GORELEASER_IMAGE}" --clean "$@"

    echo "Releases built. Archives can be found in dist/goreleaser"
}

main "$@"
